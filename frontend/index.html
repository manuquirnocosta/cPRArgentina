<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>cPRArgentina</title>
  <style>
    body {
      font-family: Verdana, Geneva, sans-serif;
      background-color: #f8f9fa;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #0077b6;
      color: white;
      padding: 20px;
      font-size: 2em;
      font-weight: bold;
    }
    .container {
      margin: 30px auto;
      width: 400px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input[type="text"] {
      width: 95%;
      padding: 8px;
      margin-top: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .nota {
      font-size: 0.85em;
      font-style: italic;
      color: #555;
      margin-top: 4px;
    }
    .abo-options {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 15px 0;
}

.abo-options input[type="radio"] {
  display: none; /* escondemos el c√≠rculo feo */
}

.abo-options label {
  padding: 10px 20px;
  border: 2px solid #0077b6;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  color: #0077b6;
  transition: all 0.2s ease-in-out;
}

.abo-options input[type="radio"]:checked + label {
  background-color: #0077b6;
  color: white;
}
    button {
      margin: 10px 5px;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
    }
    button#calc {
      background-color: #0077b6;
      color: white;
    }
    button#clear {
      background-color: #ccc;
      color: black;
    }

    /* Colores din√°micos seg√∫n estado */
#resultado {
  margin-top: 20px;
  font-size: 1.3em;
  font-weight: bold;
  padding: 10px;
  border-radius: 8px;
  display: inline-block;
  min-width: 150px;
  opacity: 1;
  transition: opacity 0.4s ease-in-out;
}

.resultado-cargando {
  color: #0c5460;
  background-color: #d1ecf1;
  opacity: 1;
}

.resultado-exito {
  color: #155724;
  background-color: #d4edda;
  opacity: 1;
}

.resultado-error {
  color: #721c24;
  background-color: #f8d7da;
  opacity: 1;
}

    </style>
</head>
<body>
  <header>cPRArgentina</header>
  <div class="container">
    <label for="antigenos">Ingrese aqu√≠ los ant√≠genos no deseados</label>
    <input type="text" id="antigenos" placeholder="Ej: A2 B44 DR4">
    <div class="nota">separados por un espacio o una coma</div>

    <label>Seleccione grupo sangu√≠neo:</label>
<div class="abo-options">
  <input type="radio" id="aboA" name="abo" value="A">
  <label for="aboA">A</label>

  <input type="radio" id="aboB" name="abo" value="B">
  <label for="aboB">B</label>

  <input type="radio" id="aboAB" name="abo" value="AB">
  <label for="aboAB">AB</label>

  <input type="radio" id="aboO" name="abo" value="O">
  <label for="aboO">O</label>
</div>


    <button id="calc" onclick="calcular()">Calcular</button>
    <button id="clear" onclick="limpiar()">Limpiar</button>

    <div id="errores"></div>
    <div id="resultado"></div>
  </div>

<script>
const VALID_ANTIGENS = [
  'A1','A2','A3','A11','A203','A210','A23','A24','A2403','A25','A26','A29','A30','A31','A32','A33','A34','A36','A43','A66','A68','A69','A74','A80',
  'B7','B8','B13','B18','B27','B2708','B35','B37','B38','B39','B41','B42','B44','B45','B46','B47','B48','B49','B50','B51','B52','B53','B54','B55','B56','B57','B58','B59','B60','B61','B62','B63','B64','B65','B67','B70','B71','B72','B73','B75','B76','B77','B78','B81','B82',
  'DR1','DR103','DR2','DR3','DR4','DR7','DR8','DR9','DR10','DR11','DR12','DR13','DR14','DR15','DR16','DR17','DR18',
  'DQ2','DQ3','DQ4','DQ5','DQ6','DQ7','DQ8','DQ9'
];

async function calcular() {
  var input = document.getElementById("antigenos").value;
  var aboRadio = document.querySelector("input[name='abo']:checked");
  var abo = aboRadio ? aboRadio.value : null;
  var parsed = input.split(/[\s,]+/).filter(function(x){ return x.trim() !== ""; });

  var erroresDiv = document.getElementById("errores");
  var resultadoDiv = document.getElementById("resultado");

  // limpiar mensajes previos
  erroresDiv.innerText = "";
  resultadoDiv.className = "";
  resultadoDiv.innerText = "";

  // validaciones
  if (parsed.length === 0 || !abo) {
    erroresDiv.innerText = "‚ö†Ô∏è Ingres√° al menos un ant√≠geno y seleccion√° un grupo sangu√≠neo.";
    return;
  }

  var invalid = parsed.filter(function(a){ return VALID_ANTIGENS.indexOf(a) === -1; });
  var valid = parsed.filter(function(a){ return VALID_ANTIGENS.indexOf(a) !== -1; });

  if (invalid.length > 0) {
    erroresDiv.innerText = "‚ö†Ô∏è Ant√≠genos no v√°lidos: " + invalid.join(", ");
  }

  resultadoDiv.className = "resultado-cargando";
  resultadoDiv.innerText = "‚è≥ Calculando...";

  try {
    var res = await fetch("/calc_cpra", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ antigenos: valid, abo: abo })
    });

    if (!res.ok) {
      throw new Error("Respuesta HTTP " + res.status);
    }

    var data = await res.json();

    await new Promise(r => setTimeout(r, 500)); // üëà peque√±o delay para que se vea el cartel
    if (data.cPRA !== undefined) {
      resultadoDiv.className = "resultado-exito";
      resultadoDiv.innerText = "‚úÖ cPRA: " + data.cPRA.toFixed(1) + "%";
    } else if (data.error) {
      resultadoDiv.className = "resultado-error";
      resultadoDiv.innerText = "‚ùå " + data.error;
    } else {
      resultadoDiv.className = "resultado-error";
      resultadoDiv.innerText = "‚ùå Respuesta inesperada del servidor.";
    }
  } catch (err) {
    console.error("Error:", err);
    resultadoDiv.className = "resultado-error";
    resultadoDiv.innerText = "‚ùå Error conectando con el servidor o procesando la respuesta.";
  }
}

function limpiar() {
  document.getElementById("antigenos").value = "";
  document.getElementById("resultado").innerText = "";
  document.getElementById("resultado").className = "";
  document.getElementById("errores").innerText = "";
  var radios = document.querySelectorAll("input[name='abo']");
  for (var i=0; i<radios.length; i++) {
    radios[i].checked = false;
  }
}
</script>
</body>
</html>
