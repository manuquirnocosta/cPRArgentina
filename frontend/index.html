<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>cPRArgentina</title>

  <style>
    body {
      font-family: Verdana, Geneva, sans-serif;
      background-color: #f8f9fa;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #0077b6;
      color: white;
      padding: 20px;
      font-size: 2em;
      font-weight: bold;
    }

    .container {
      margin: 30px auto;
      width: 420px;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      text-align: center;
    }

    input[type="text"] {
      width: 95%;
      padding: 8px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .nota {
      font-size: 0.85em;
      font-style: italic;
      color: #555;
      margin-top: 8px;
      text-align: center;
    }

    .abo-options {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 1px 0 15px 0;
    }

    .abo-options input[type="radio"] {
      display: none;
    }

    .abo-options label {
      padding: 10px 18px;
      border: 2px solid #0077b6;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      color: #0077b6;
      transition: all 0.2s ease-in-out;
    }

    .abo-options input[type="radio"]:checked+label {
      background-color: #0077b6;
      color: white;
    }

    .method-options {
    margin: 10px 0 20px 0;
    font-size: 0.9em;
    text-align: center;
    }
        
    .method-options div {
    justify-content: center;
    }

    .method-options div {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    }

    .method-options label {
    margin: 0;
    font-weight: normal;
    }


    button {
      margin: 10px 5px;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
    }

    button#calc {
      background-color: #0077b6;
      color: white;
    }

    button#clear {
      background-color: #ccc;
      color: black;
    }

    #resultado {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      background-color: #f1f3f5;
      min-height: 60px;
    }

    .resultado-numero {
      font-size: 2em;
      font-weight: bold;
      color: #155724;
    }

    .resultado-meta {
      margin-top: 8px;
      font-size: 0.8em;
      color: #555;
    }

    .resultado-error {
      color: #721c24;
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 8px;
    }

    #dataset-info {
      margin-top: 25px;
      font-size: 0.75em;
      color: #888;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }

    .footer-note {
      margin-top: 20px;
      font-size: 0.7em;
      color: #777;
    }
  </style>
</head>

<body>

  <header>cPRArgentina</header>

  <div class="container">

    <label for="antigenos">Ingrese aqu√≠ los ant√≠genos no deseados</label>
    <input type="text" id="antigenos" placeholder="Ej: A2 B44 DR4">
    <div class="nota">(separados por un espacio o una coma)</div>

    <label>Seleccione grupo sangu√≠neo:</label>
    <div class="abo-options">
      <input type="radio" id="aboA" name="abo" value="A">
      <label for="aboA">A</label>

      <input type="radio" id="aboB" name="abo" value="B">
      <label for="aboB">B</label>

      <input type="radio" id="aboAB" name="abo" value="AB">
      <label for="aboAB">AB</label>

      <input type="radio" id="aboO" name="abo" value="O">
      <label for="aboO">O</label>
    </div>

    <label>M√©todo de c√°lculo:</label>
    <div class="method-options">
      <div>
        <input type="radio" id="modeFreq" name="mode" value="freq" checked>
        <label for="modeFreq">probabil√≠stico (freq)</label>
      </div>
      <div>
        <input type="radio" id="modeFilter" name="mode" value="filter"> 
        <label for="modeFilter">emp√≠rico (filter)</label>
      </div>
    </div>

    <button id="calc" onclick="calcular()">Calcular</button>
    <button id="clear" onclick="limpiar()">Limpiar</button>

    <div id="errores"></div>
    <div id="resultado"></div>

    <div id="dataset-info">
      ‚è≥ Cargando informaci√≥n de base...
    </div>

    <div class="footer-note">
      Research Use Only ‚Äì Prototype Version 1.0
    </div>

  </div>

  <script>

    async function cargarInfoDataset() {
      try {
        const res = await fetch("/dataset_info");
        const data = await res.json();

        document.getElementById("dataset-info").innerHTML =
          "üìä Donantes en base: <b>" + data.total_donors + "</b><br>" +
          "üîÑ √öltima actualizaci√≥n: <b>" + data.last_update + "</b>";

      } catch {
        document.getElementById("dataset-info").innerText =
          "‚ö†Ô∏è No se pudo cargar informaci√≥n de base.";
      }
    }

    window.onload = function () {
      cargarInfoDataset();
    };

    async function calcular() {

      var input = document.getElementById("antigenos").value;
      var aboRadio = document.querySelector("input[name='abo']:checked");
      var abo = aboRadio ? aboRadio.value : null;
      var parsed = input.split(/[\s,]+/).filter(x => x.trim() !== "");

      var modeRadio = document.querySelector("input[name='mode']:checked");
      var mode = modeRadio ? modeRadio.value : "freq";

      var resultadoDiv = document.getElementById("resultado");
      resultadoDiv.innerHTML = "";

      if (parsed.length === 0 || !abo) {
        resultadoDiv.innerHTML =
          "<div class='resultado-error'>Ingres√° al menos un ant√≠geno y seleccion√° un grupo sangu√≠neo.</div>";
        return;
      }

      try {
        var res = await fetch("/calc_cpra", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ antigenos: parsed, abo: abo, mode: mode })
        });

        var data = await res.json();

        if (data.cPRA !== undefined) {
          resultadoDiv.innerHTML =
            "<div class='resultado-numero'>" + data.cPRA.toFixed(1) + "%</div>" +
            "<div class='resultado-meta'>" +
            "M√©todo utilizado: " + data.mode_used.toLowerCase() + "<br>" 
            "</div>";
        } else {
          resultadoDiv.innerHTML =
            "<div class='resultado-error'>Error inesperado.</div>";
        }

      } catch {
        resultadoDiv.innerHTML =
          "<div class='resultado-error'>Error conectando con el servidor.</div>";
      }
    }

    function limpiar() {
      document.getElementById("antigenos").value = "";
      document.getElementById("resultado").innerHTML = "";
      document.querySelectorAll("input[name='abo']").forEach(r => r.checked = false);
      document.getElementById("modeFreq").checked = true;
    }

  </script>

</body>

</html>
